<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Casos internos | Salvatori</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex,nofollow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --rojo:#c62828;
            --rojo-osc:#8e0000;
            --gris:#f5f5f5;
        }
        *{box-sizing:border-box;}
        body{
            margin:0;
            font-family:'Poppins',sans-serif;
            background:var(--gris);
        }
        header{
            background:#fff;
            border-bottom:3px solid var(--rojo);
        }
        .nav-container{
            max-width:1000px;margin:auto;padding:10px 16px;
            display:flex;align-items:center;justify-content:space-between;
        }
        .logo-area{display:flex;align-items:center;gap:10px;}
        .logo-img{width:44px;height:44px;border-radius:8px;overflow:hidden;background:#111;}
        .logo-img img{width:100%;height:100%;object-fit:contain;}
        main{max-width:1000px;margin:auto;padding:16px;}
        h1{font-size:22px;margin:8px 0;}
        .sub{font-size:12px;color:#555;margin-bottom:12px;}
        .layout{
            display:grid;grid-template-columns:minmax(0,1.3fr) minmax(0,1.2fr);
            gap:18px;
        }
        @media(max-width:900px){.layout{grid-template-columns:1fr;}}
        .card{
            background:#fff;border-radius:12px;padding:14px;
            box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:14px;
        }
        .card h2{margin:0 0 8px;font-size:16px;border-left:4px solid var(--rojo);padding-left:8px;}
        label{font-size:13px;font-weight:600;display:block;margin-top:10px;}
        input[type="text"],input[type="date"],textarea,select{
            width:100%;padding:8px 10px;margin-top:4px;
            border-radius:8px;border:1px solid #ccc;font-family:inherit;font-size:14px;
        }
        textarea{min-height:70px;resize:vertical;}
        .fila-doble{display:flex;gap:10px;}
        .fila-doble>div{flex:1;}
        .file-input{
            border:1px dashed #bbb;border-radius:8px;padding:10px;margin-top:4px;
            text-align:center;font-size:12px;color:#666;background:#fafafa;
        }
        .file-input input{display:block;margin:6px auto 0;}
        .preview-img{
            width:100%;max-height:150px;object-fit:cover;border-radius:8px;
            margin-top:6px;display:none;
        }
        .btn{
            border:none;border-radius:20px;padding:8px 16px;
            font-size:13px;font-weight:600;cursor:pointer;
            display:inline-flex;align-items:center;gap:6px;
        }
        .btn-primary{background:var(--rojo);color:#fff;}
        .btn-primary:hover{background:var(--rojo-osc);}
        .btn-secondary{background:#eee;color:#333;}
        .btn-danger{background:#b00020;color:#fff;}
        .acciones-form{margin-top:14px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}
        table{
            width:100%;border-collapse:collapse;font-size:12px;
        }
        th,td{border-bottom:1px solid #eee;padding:6px 4px;text-align:left;}
        th{background:#fafafa;font-weight:600;}
        .tag{font-size:11px;color:#777;}
        .acciones-lista button{margin-right:4px;margin-top:2px;}
        .mensaje{font-size:12px;margin-top:6px;}
        .ok{color:#2e7d32;}
        .error{color:#c62828;}
    </style>
</head>
<body>
<header>
    <div class="nav-container">
        <div class="logo-area">
            <div class="logo-img">
                <img src="img/logo-salvatori.png" alt="Logo">
            </div>
            <div>
                <strong style="font-size:14px;">Salvatori Servicio Automotriz</strong><br>
                <span style="font-size:11px;">Panel interno · Casos reales</span>
            </div>
        </div>
        <div style="font-size:11px;">
            <a href="index.html" style="text-decoration:none;color:var(--rojo);font-weight:600;">⮜ Volver al inicio</a>
        </div>
    </div>
</header>

<main>
    <h1>Casos reales del taller</h1>
    <p class="sub">
        Desde aquí puedes <strong>agregar, editar y borrar</strong> los casos que se muestran en la página principal.
        Las fotos se suben al servidor y se comparten en todos los equipos.
    </p>

    <div class="layout">
        <!-- FORMULARIO -->
        <div>
            <div class="card">
                <h2 id="tituloForm">Nuevo caso</h2>
                <form id="formCaso" enctype="multipart/form-data">
                    <input type="hidden" name="id" id="campoId">
                    <div class="fila-doble">
                        <div>
                            <label>Título del caso</label>
                            <input type="text" name="titulo" id="campoTitulo" placeholder="Ej. Motor · Pérdida de fuerza" required>
                        </div>
                        <div>
                            <label>Tipo / etiqueta</label>
                            <select name="tipo" id="campoTipo">
                                <option value="">Selecciona…</option>
                                <option value="Motor">Motor</option>
                                <option value="Transmisión">Transmisión</option>
                                <option value="Frenos">Frenos</option>
                                <option value="Suspensión">Suspensión</option>
                                <option value="Eléctrico">Eléctrico</option>
                                <option value="Servicio general">Servicio general</option>
                            </select>
                        </div>
                    </div>

                    <label>Cliente / referencia (opcional)</label>
                    <input type="text" name="cliente" id="campoCliente" placeholder="Solo iniciales o descripción, sin apellidos completos.">

                    <div class="fila-doble">
                        <div>
                            <label>Fecha del trabajo</label>
                            <input type="date" name="fecha" id="campoFecha">
                        </div>
                    </div>

                    <label>Problema reportado</label>
                    <textarea name="problema" id="campoProblema" placeholder="Ej. Golpeteo al pasar baches y auto inestable a alta velocidad." required></textarea>

                    <label>Solución realizada</label>
                    <textarea name="solucion" id="campoSolucion" placeholder="Ej. Cambio de amortiguadores, bujes y topes; revisión de alineación." required></textarea>

                    <label>Resultado</label>
                    <textarea name="resultado" id="campoResultado" placeholder="Ej. Conducción estable y sin ruidos; cliente listo para trabajar en plataforma." required></textarea>

                    <div class="fila-doble">
                        <div>
                            <label>Foto ANTES</label>
                            <div class="file-input">
                                Arrastra y suelta la foto aquí o selecciónala.
                                <input type="file" name="fotoAntes" id="fotoAntes" accept="image/*">
                            </div>
                            <img id="previewAntes" class="preview-img" alt="Previsualización antes">
                        </div>
                        <div>
                            <label>Foto DESPUÉS</label>
                            <div class="file-input">
                                Arrastra y suelta la foto aquí o selecciónala.
                                <input type="file" name="fotoDespues" id="fotoDespues" accept="image/*">
                            </div>
                            <img id="previewDespues" class="preview-img" alt="Previsualización después">
                        </div>
                    </div>

                    <div class="acciones-form">
                        <button type="button" class="btn btn-secondary" id="btnNuevo">Nuevo</button>
                        <button type="submit" class="btn btn-primary" id="btnGuardar">Guardar caso</button>
                    </div>
                    <div id="msgForm" class="mensaje"></div>
                </form>
            </div>
        </div>

        <!-- LISTA -->
        <div>
            <div class="card">
                <h2>Casos registrados</h2>
                <p class="sub" style="margin-bottom:8px;">Lo que agregues aquí se mostrará en la sección “Casos reales” del sitio.</p>
                <table id="tablaCasos">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Tipo</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Se llena por JS -->
                    </tbody>
                </table>
                <div id="msgLista" class="mensaje"></div>
            </div>
        </div>
    </div>
</main>

<script>
const API_URL = 'casos_api.php';

const formCaso = document.getElementById('formCaso');
const campoId = document.getElementById('campoId');
const tituloForm = document.getElementById('tituloForm');
const msgForm = document.getElementById('msgForm');
const msgLista = document.getElementById('msgLista');
const tablaBody = document.querySelector('#tablaCasos tbody');
const btnNuevo = document.getElementById('btnNuevo');

const previewAntes = document.getElementById('previewAntes');
const previewDespues = document.getElementById('previewDespues');
const inputFotoAntes = document.getElementById('fotoAntes');
const inputFotoDespues = document.getElementById('fotoDespues');

function limpiarPreview(input, imgEl) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = e => {
            imgEl.src = e.target.result;
            imgEl.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        imgEl.src = '';
        imgEl.style.display = 'none';
    }
}

inputFotoAntes.addEventListener('change', () => limpiarPreview(inputFotoAntes, previewAntes));
inputFotoDespues.addEventListener('change', () => limpiarPreview(inputFotoDespues, previewDespues));

function modoNuevo() {
    campoId.value = '';
    tituloForm.textContent = 'Nuevo caso';
    formCaso.reset();
    previewAntes.style.display = 'none';
    previewDespues.style.display = 'none';
    msgForm.textContent = '';
}
btnNuevo.addEventListener('click', modoNuevo);

// Cargar casos de la API
async function cargarCasos() {
    msgLista.textContent = 'Cargando casos...';
    try {
        const res = await fetch(API_URL + '?action=list');
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Error al leer casos');

        tablaBody.innerHTML = '';
        if (!data.casos || data.casos.length === 0) {
            msgLista.textContent = 'No hay casos registrados todavía.';
            return;
        }
        msgLista.textContent = '';

        data.casos.forEach(caso => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${caso.titulo || ''}</td>
                <td><span class="tag">${caso.tipo || '-'}</span></td>
                <td>${caso.fecha || ''}</td>
                <td class="acciones-lista">
                    <button class="btn btn-secondary btn-sm" data-id="${caso.id}" data-accion="editar">Editar</button>
                    <button class="btn btn-danger btn-sm" data-id="${caso.id}" data-accion="borrar">Borrar</button>
                </td>
            `;
            tablaBody.appendChild(tr);
        });

    } catch (err) {
        console.error(err);
        msgLista.textContent = 'Error al cargar la lista de casos.';
        msgLista.classList.add('error');
    }
}

// Al hacer click en editar/borrar
tablaBody.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const accion = btn.getAttribute('data-accion');

    if (accion === 'borrar') {
        if (!confirm('¿Seguro que quieres borrar este caso?')) return;
        await borrarCaso(id);
        return;
    }

    if (accion === 'editar') {
        await cargarCasoEnFormulario(id);
    }
});

async function cargarCasoEnFormulario(id) {
    try {
        const res = await fetch(API_URL + '?action=list');
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Error');

        const caso = (data.casos || []).find(c => c.id === id);
        if (!caso) {
            alert('No se encontró el caso.');
            return;
        }

        campoId.value = caso.id;
        document.getElementById('campoTitulo').value = caso.titulo || '';
        document.getElementById('campoTipo').value = caso.tipo || '';
        document.getElementById('campoCliente').value = caso.cliente || '';
        document.getElementById('campoFecha').value = caso.fecha || '';
        document.getElementById('campoProblema').value = caso.problema || '';
        document.getElementById('campoSolucion').value = caso.solucion || '';
        document.getElementById('campoResultado').value = caso.resultado || '';

        // previsualizar imágenes existentes si las hay
        if (caso.fotoAntes) {
            previewAntes.src = caso.fotoAntes;
            previewAntes.style.display = 'block';
        } else {
            previewAntes.style.display = 'none';
        }

        if (caso.fotoDespues) {
            previewDespues.src = caso.fotoDespues;
            previewDespues.style.display = 'block';
        } else {
            previewDespues.style.display = 'none';
        }

        tituloForm.textContent = 'Editar caso';

        msgForm.textContent = 'Editando caso existente. Guarda para aplicar cambios.';
        msgForm.className = 'mensaje';

    } catch (err) {
        console.error(err);
        alert('Error al cargar el caso para edición.');
    }
}

async function borrarCaso(id) {
    try {
        const formData = new FormData();
        formData.append('action', 'delete');
        formData.append('id', id);

        const res = await fetch(API_URL, {
            method: 'POST',
            body: formData
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Error al borrar');

        await cargarCasos();
    } catch (err) {
        console.error(err);
        alert('No se pudo borrar el caso.');
    }
}

// Guardar (crear o editar)
formCaso.addEventListener('submit', async (e) => {
    e.preventDefault();
    msgForm.textContent = 'Guardando...';
    msgForm.className = 'mensaje';

    const formData = new FormData(formCaso);
    const id = campoId.value.trim();
    formData.append('action', id ? 'update' : 'create');

    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            body: formData
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Error al guardar');

        msgForm.textContent = '✅ Caso guardado correctamente.';
        msgForm.className = 'mensaje ok';

        await cargarCasos();
        // Si era nuevo, limpiar; si era edición, dejamos el contenido
        if (!id) {
            modoNuevo();
        }

    } catch (err) {
        console.error(err);
        msgForm.textContent = '❌ No se pudo guardar el caso.';
        msgForm.className = 'mensaje error';
    }
});

cargarCasos();
</script>
</body>
</html>
